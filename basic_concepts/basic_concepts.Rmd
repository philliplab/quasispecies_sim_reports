---
title: Basic concepts of quasispecies simulation
output: 
  html_document:
    toc: false
    theme: cerulean
---

```{r, include=FALSE}
library(yasss)
library(knitr)
library(rmarkdown)
library(tidyr)

knitr::opts_chunk$set(echo = FALSE)
options(scipen = 99)

report_start_time <- proc.time()
```

```{r , include = FALSE}
source('../utilities/reporting_utilities.R')
```

# Simple first simulation

A first simulation to demonstrate the process and the measuring tools. The
following table shows the configuration that was used to call `sim_pop` from
the `yasss` package. A high level summary of the entire genealogy is provided
in the second table.

```{r sim-pop-config, results = 'asis'}
arg_set1 <- list(
  label = 'A',
  ancestors = paste(rep("A", 500), collapse = ''),
  r0 = 2,
  n_gen = 9,
  n_pop = Inf,
  mutator = list(fun = "mutator_uniform_fun",
                 args = list(mu = 0.1)),
  fitness_evaluator = list(fun = "fitness_evaluator_uniform_fun",
                           args = NULL),
  required_fitness = 0
)

many_pops <- sim_proc_many_pops(list(arg_set1), output_genealogy = 'full', output_dmat = TRUE)
names(many_pops)
x <- many_pops$all_genealogies[[1]]

#x <- do.call(sim_pop, args)
#
kable(
  sim_pop_arg_formatter(arg_set1),
  booktabs = TRUE,
  caption = "Configuration with which sim_pop was called."
)
```

```{r first-sum-tab, results = 'asis'}
g_sum_tab <- genealogy_summary_table(x)

kable(
  g_sum_tab,
  booktabs = TRUE,
  caption = "Individuals per generation and the average distance to the original ancestor for the generation."
)
```

Our primary interested is restricted to the final generation which corresponds to the generation that we will obtain from sequencing a sample.
Hence we need to capture some of the key information about the last generation and figure out ways to compare it to other simulations.
Three key ways to look at this data is:

- The average of all the pairwise distances between the sequences.
- A density plot of the distribution of all the pairwise distances.
- The deciles / quartiles / some other set of percentiles of the distribution.

For now we will present all three. Once we have some solid results to argue about we can look at dropping some of these metrics.

```{r, include = FALSE}
last_gen <-
x %>%
  filter(gen_num == max(gen_num))

dmat <- many_pops$all_dmats[[1]]$dmat
avg_hd <- mean(dmat)
dvec <- as.numeric(dmat)/min(nchar(last_gen$the_seq))
dd.f <- data.frame(dists = dvec)
```

The average pairwise HD is **`r round(avg_hd, 2)`** and normalized by the length of the sequence it is **`r round(avg_hd/min(nchar(last_gen$the_seq)), 3)`**. The distribution is shown in the figure below and the deciles are listed in a table below the figure.

