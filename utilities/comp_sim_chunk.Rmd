The following graphs and tables present a summary of a set of simulations that can be divided into `r length(unique(group_membership$group_id))` groups. 

```{r, include = FALSE}
chunk_seed <- 1000000
seq_length <- nchar(all_sim_results[1,'the_seq'])

last_gens <-
all_sim_results %>%
  filter(gen_num == max(gen_num))

dmat_metrics <- data.frame(sim_id = numeric(0),
                           group_label = character(0),
                           metric = character(0),
                           value = numeric(0))

dmat_distributions <- list()

#dd.f <- NULL
down_selection_for_dmats <- NULL
c_sim_id <- unique(all_sim_results$sim_id)[1]
for (c_sim_id in unique(all_sim_results$sim_id)){
  set.seed(report_seed + chunk_seed + c_sim_id)
  print(c_sim_id)
  c_group_label <- unique(last_gens$group_label[last_gens$sim_id == c_sim_id])
  stopifnot(length(c_group_label) == 1)
  c_gen <- last_gens$the_seq[last_gens$sim_id == c_sim_id]
  if (length(c_gen) > 10000){
    ds_gen <- c_gen[sample(1:length(c_gen), 10000)]
  } else {
    ds_gen <- c_gen
  }
  down_selection_for_dmats <- rbind(down_selection_for_dmats,
    data.frame(true_gen_size = length(c_gen),
               seqs_used_for_dmat = length(ds_gen)))
  
  dmat <- memoiseCache(fun = 'stringdistmatrix',
                       args = list(a = ds_gen,
                                   method = 'hamming'),
                       cacheName = 'dmat')

  avg_hd <- mean(dmat)
  deciles <- quantile(dmat, (0:10)/10)
  dmat_metrics <- rbind(dmat_metrics,
    data.frame(
      sim_id = c_sim_id,
      group_label = c_group_label,
      metric = c("avg_hd", gsub("^", "p", gsub("\\.", "_", gsub("\\%", "", names(deciles))))),
      value = c(avg_hd, deciles)))

  dmat_distributions[[as.character(c_sim_id)]] <- density(dmat)
#  dvec <- as.numeric(dmat)/min(nchar(last_gens$the_seq))
#  dd.f <- rbind(dd.f,
#    data.frame(sim_id = c_sim_id,
#               group_label = c_group_label,
#               dists = dvec)
#  )
}
```

```{r, results = 'asis'}
down_selection_for_dmats_for_kable <- down_selection_for_dmats

names(down_selection_for_dmats_for_kable) <- c(
  "Number of sequences in simulated dataset",
  "Number of sequences included in distance matrix"
  )

kable(down_selection_for_dmats_for_kable,
      booktabs = TRUE,
      caption = "Number of sequences used to compute distance matrices")
```


```{r, results = 'asis'}
avg_hd_summary_table <- dmat_metrics %>% 
    filter(metric == 'avg_hd') %>%
    group_by(group_label) %>%
    summarize(avg_hd = mean(value),
              n_avg_hd = mean(value) / seq_length)

names(avg_hd_summary_table) <- c(
  "Group Label",
  "Average Pairwise HD.",
  "Normalized Average Pairwise HD.")

kable(avg_hd_summary_table,
  booktabs = TRUE,
  caption = "The average pairwise HD in each group of simulations"
)
```

```{r, fig.cap='Density plot of the pariwise distances in the last generation', results = 'asis'}
#  dmat_distributions[[c_sim_id]] <- density(dmat)
dmat_distributions_df <- NULL
i <- 1
for (j in names(dmat_distributions)){
  i <- as.numeric(j)
  group_id <- group_membership %>% filter(sim_id == i) %>% select(group_id)
  group_id <- group_id[1,1]
  group_label <- arg_sets[[group_id]]$group_label
  dmat_distributions_df <- rbind(dmat_distributions_df,
    data.frame(sim_id = i,
               group_label = group_label,
               x = dmat_distributions[[i]]$x,
               y = dmat_distributions[[i]]$y)
    )
}

ggplot(dmat_distributions_df, aes(x = x, y = y, group = sim_id, color = group_label)) +
  geom_smooth(se = FALSE, size = 0.75, span = 0.1, method = 'loess')
```

```{r, results = 'asis'}

deciles <-
dmat_metrics %>% 
  filter(grepl("^p", metric)) %>%
  group_by(group_label, metric) %>%
  summarize(
    value = mean(value)
   )

all_deciles <-
spread(deciles, metric, value)

kable(
  all_deciles,
  booktabs = TRUE,
  caption = "The deciles of the pairwise HDs"
)
```

```{r, results = 'asis'}
arg_tab <- NULL
for (c_group_id in names(arg_sets)){
  c_arg_tab <- sim_pop_arg_formatter(arg_sets[[c_group_id]]$args)
  original_cols <- names(c_arg_tab)
  c_arg_tab$group_label <- arg_sets[[c_group_id]]$group_label
  c_arg_tab <- c_arg_tab %>% select(group_label, original_cols)
  if (is.null(arg_tab)){
    arg_tab <- c_arg_tab
  } else {
    arg_tab <- rbind(arg_tab, c_arg_tab)
  }
}
for (i in 1:nrow(arg_tab)){
  if (nchar(arg_tab$Value[i]) > 50){
    arg_tab$Value[i] <- paste(substr(arg_tab$Value[i], 1, 50), '...', sep = '')
  }
}

kable(
  arg_tab,
  booktabs = TRUE,
  caption = "Configuration with which sim_pop was called for the group for each group of simulations."
)
```

```{r, results = 'asis'}
all_sum_tabs <- NULL
for (c_group_label in unique(all_sim_results$group_label)){
  g_sum_tab <- genealogy_summary_table(all_sim_results[all_sim_results$group_label == c_group_label, c(-1,-2)])
  original_cols <- names(g_sum_tab)
  g_sum_tab$group_label <- c_group_label
  g_sum_tab <- g_sum_tab %>% select(group_label, original_cols)
  if (is.null(all_sum_tabs)){
    all_sum_tabs <- g_sum_tab
  } else {
    all_sum_tabs <- rbind(all_sum_tabs, g_sum_tab)
  }
}

kable(
  all_sum_tabs,
  booktabs = TRUE,
  caption = "Individuals per generation and the average distance to the original ancestor for the generation for all simulations grouped by simulation group."
)
```

